<link rel="import" href="left-swipe-action-button.html">

<polymer-element name="left-swipe-action" attributes="open nodrag offset">
    <template>
        <style>
            :host {
                position: relative;
                width: 100%;
            }

            .swipe-underlay {
                position: absolute;
                width: 75%;
                height: 100%;
                right: 0;
                display: table;
            }

            .swipe-content {
                -webkit-transform-style: preserve-3d;
                -moz-transform-style: preserve-3d;
                -ms-transform-style: preserve-3d;
                -o-transform-style: preserve-3d;
                transform-style: preserve-3d;
                -webkit-backface-visibility: hidden;
                -moz-backface-visibility: hidden;
                -ms-backface-visibility: hidden;
                -o-backface-visibility: hidden;
                backface-visibility: hidden;
            }

            .fixed-true {
                -webkit-transition: -webkit-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                -moz-transition: -moz-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                -ms-transition: -ms-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                -o-transition: -o-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                transition: transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
            }
        </style>
        <div class="swipe-underlay" layout horizontal reverse center>
            <content select="left-swipe-action-button"></content>
        </div>
        <div id="content" class="swipe-content fixed-{{!point.updated}} open-{{open}}">
            <content></content>
        </div>
    </template>
    <script>

        var xPoint = function(x){
            this.updated = false;
            this.x = this._prev = this._origin = x;
            this._timeStamp = (new Date()).getTime();
        };
        xPoint.prototype = {
            MIN_VELOCITY: -0.5 /* px/ms */,

            distance: function(){
                return this.x - this._origin;
            },

            update: function(x){
                // reset time stamp at move stop
                if(x - this.x > -5){
                    this._timeStamp = (new Date()).getTime();
                    this._prev = this.x;
                }
                this.x = x;
                this.updated = true;
            },

            isFlick: function(){
                var dt = (new Date()).getTime() - this._timeStamp;
                var dx = this.x - this._prev;
                var v = dx / dt;
                return v < this.MIN_VELOCITY;
            }
        };

        var util = {
            applyTransform: function(n, move){
                var value = "translate3d(" + move + "px, 0, 0)";
                n.style.webkitTransform = value;
                n.style.MozTransform = value;
                n.style.msTransform = value;
                n.style.OTransform = value;
                n.style.transform = value;
            }
        }; 

        Polymer({
            /**
             * If true, the content is opened.
             *
             * @attribute open
             * @type boolean
             * @default false
             */
            open: false,

            /**
             * If true, drag is disabled and a content is moved by click
             *
             * @attribute nodrag
             * @type boolean
             * @default false
             */
            nodrag: false,

            /**
             * offset pixcel position for opened state
             *
             * @attribute offset
             * @type number
             * @default 60
             */
            offset: 60,

            ready: function(){
                if(this.nodrag){
                    this.$.content.addEventListener("pointerup", this.toggleOpen.bind(this));
                }else{
                    this.$.content.addEventListener("pointerdown", this.onDown.bind(this));
                    this.$.content.addEventListener("pointermove", this.onMove.bind(this));
                    this.$.content.addEventListener("pointerup", this.onUp.bind(this));
                    this.$.content.addEventListener("pointerout", this.onUp.bind(this));
                }
                this.transition();
            },

            onDown: function(e){
                this.point = new xPoint(e.clientX);
            },

            onMove: function(e){
                if(this.point){
                    this.point.update(e.clientX);
                    util.applyTransform(this.$.content, this.open ? this.offset - this.$.content.clientWidth + this.point.distance() : this.point.distance());
                }
            },

            onUp: function(e){
                if(!this.point){ return; }
                this.open = this.point && this.point.isFlick();
                this.point = null;
                // apply css fixed-true first
                this.async(this.transition);
            },

            transition: function(){
                util.applyTransform(this.$.content, this.open ? this.offset - this.$.content.clientWidth : 0);
            },

            toggleOpen: function(){
                this.open = !this.open;
                this.transition();
            }
        });
    </script>
</polymer-element>