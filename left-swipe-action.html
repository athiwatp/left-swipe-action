<link rel="import" href="left-swipe-action-button.html">

<polymer-element name="left-swipe-action" attributes="open nodrag">
    <template>
        <style>
            :host {
                position: relative;
                width: 100%;
            }

            .swipe-underlay {
                position: absolute;
                width: 75%;
                height: 100%;
                right: 0;
                display: table;
            }

            .swipe-content {
                position: relative;
                -webkit-transform: translate3d(0, 0, 0);
                -moz-transform: translate3d(0, 0, 0);
                -ms-transform: translate3d(0, 0, 0);
                -o-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);

                -webkit-transform-style: preserve-3d;
                -moz-transform-style: preserve-3d;
                -ms-transform-style: preserve-3d;
                -o-transform-style: preserve-3d;
                transform-style: preserve-3d;

                -webkit-backface-visibility: hidden;
                -moz-backface-visibility: hidden;
                -ms-backface-visibility: hidden;
                -o-backface-visibility: hidden;
                backface-visibility: hidden;
            }

            .fixed-true {
                -webkit-transition: -webkit-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                -moz-transition: -moz-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                -ms-transition: -ms-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                -o-transition: -o-transform .5s cubic-bezier(.10, .70, .10, 1) .05s;
                transition: transform .5s cubic-bezier(.10, .70, .10, 1) .05s;            
            }

            .fixed-true.open-true {
                -webkit-transform: translate3d(-80%, 0, 0);
                -moz-transform: translate3d(-80%, 0, 0);
                -ms-transform: translate3d(-80%, 0, 0);
                -o-transform: translate3d(-80%, 0, 0);
                transform: translate3d(-80%, 0, 0);
            }

            .fixed-true.open-false {
 /*               -webkit-transform: translate3d(0, 0, 0);
                -moz-transform: translate3d(0, 0, 0);
                -ms-transform: translate3d(0, 0, 0);
                -o-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);*/
            }
        </style>

        <div class="swipe-underlay" layout horizontal reverse center>
            <content select="left-swipe-action-button"></content>
        </div>
        <div id="content" class="swipe-content fixed-{{!point.updated}} open-{{open}}">
            <content></content>
        </div>
    </template>
    <script>

        function xPoint(x){
            this.updated = false;
            this.x = this._origin = x;
            this._timeStamp = (new Date()).getTime();
        };
        xPoint.prototype = {
            MIN_VELOCITY: 0.5 /* px/ms */,

            distance: function(){
                return this.x - this._origin;
            },

            update: function(x){
                console.log(x - this.x);
                // reset time stamp at move stop
                if(x - this.x > -5){
                    console.log("refresh timestamp!!")
                    this._timeStamp = (new Date()).getTime();
                }
                this.x = x;
                this.updated = true;
            },

            isFlick: function(){
                var dt = (new Date()).getTime() - this._timeStamp;
                var dx = this.distance();
                var v = -(dx / dt);
                console.log(v);
                return v > this.MIN_VELOCITY;
            }
        };

        function setTranslate(n, move){
            setTransform(n, "translate3d(" + move + "px, 0, 0)");
        }

        function clearTranslate(n){
            setTransform(n, "");
        }

        function setTransform(n, value){
            n.style.webkitTransform = value;
            n.style.MozTransform = value;
            n.style.msTransform = value;
            n.style.OTransform = value;
            n.style.transform = value;
        }

        Polymer({
            /**
             * If true, the content is opened.
             *
             * @attribute open
             * @type boolean
             * @default false
             */
            open: false,

            /**
             * If true, drag is disabled and a content is moved by click
             *
             * @attribute nodrag
             * @type boolean
             * @default false
             */
            nodrag: false,

            ready: function(){
                if(this.nodrag){
                    this.$.content.addEventListener("pointerup", this.toggleOpen.bind(this));
                }else{
                    this.$.content.addEventListener("pointerdown", this.onDown.bind(this));
                    this.$.content.addEventListener("pointermove", this.onMove.bind(this));
                    this.$.content.addEventListener("pointerup", this.onUp.bind(this));
                }
            },

            onDown: function(e){
                // setup move event
                console.log("down");
                // store current position
                this.point = new xPoint(e.x);
            },

            onMove: function(e){
                if(this.point){
                    this.point.update(e.x);
                    setTranslate(this.$.content, this.point.distance());
                }
            },

            onUp: function(e){
                console.log("up");
                clearTranslate(this.$.content);
                this.open = this.point && this.point.isFlick();
                this.point = null;
                console.log("this.open: " + this.open);
            },

            toggleOpen: function(){
                this.open = !this.open;
            }
        });
    </script>
</polymer-element>